#!/bin/bash

# github URLs
function github_urls {
  awk '$4 ~ /REPO/ {print $5}' data/github-urls.tsv | sort -u
}

# cache exploitdb filenames
find /usr/share/exploitdb/exploits -type f > exploitcache

for url in $(github_urls); do
  url=$url awk '$5 == ENVIRON["url"] { print $1 }' data/github-urls.tsv > exploit_ids

  # get list of tags for this url
  tf=$(mktemp -d)
  git clone $url $tf 2>/dev/null
  cat $tf/.git/packed-refs > urltags 2>/dev/null
  rm -rf $tf

  for e in $(cat exploit_ids); do
    filename=$(grep $e exploitcache)
    echo "exploit $e"
    echo "github $url"
    echo "filename $filename"
    grep '^# ' $filename
    echo "BEGIN_TAGS"
    awk '
    NF == 2 && $2 ~ /^refs\/tags\// {
      gsub(/^refs\/tags\//,"",$2)
      print $2
    }
    ' urltags
    echo ""
  done
done
