#!/bin/bash

# function from https://gist.github.com/amalmurali47/85bf80e7df4939070d10a7d29d5f2d60
function extract() {
    filename=$1
    if [ -f "$filename" ]; then
        case "$filename" in
            *.tar.xz)   tar xvfJ "$filename"                          ;;
            *.tar.gz)   tar --gzip -xvf "$filename"                   ;;
            *.tar.bz2)  tar --bzip2 -xvf "$filename"                  ;;
            *.tar)      tar -xvf "$filename"                          ;;
            *.tgz)      tar --gzip -xvf "$filename"                   ;;
            *.tbz2)     tar --bzip2 -xvf "$filename"                  ;;
            *.bz2)      bunzip2 "$filename"                           ;;
            *.7z)       7za x "$filename"                             ;;
            *.Z)        uncompress --keep "$filename"                 ;;
            *.zip)      unzip "$filename"                             ;; # -d ${filename%.*}
            *.rar)      unrar x "$filename"                           ;;
            *.jar)      jar xf "$filename"                            ;;
            *)          echo "'$filename' not supported extension"  ;;
        esac
    else
        echo "'$filename' not a file."
    fi
}

url="$1"
tf=$(mktemp -d)
cd $tf
printf "url\t%s\n" "$url"
# scan file
wget "$url" 2>/dev/null
export filename=$(ls)
printf "md5_download\t"
md5sum -- "$filename"
printf "file\t"
file -- "$filename"

# extract
extract "$filename"

#file "$filename" | awk '
#BEGIN { fn = ENVIRON["filename"] }
#/gzip/ && /from Unix/ && fn ~ /\.tar\.gz: / { system("tar -xzvf " fn " >/dev/null"); next }
#/Zip archive/ { system("unzip " fn " >/dev/null"); next }
#/bzip2 compressed/ && fn ~ /\.tar.bz2$/ { system("tar --bzip2 -xvf " fn " >/dev/null"); next }
#{print "UNKNOWN COMPRESSION", $0}
#'

echo "md5_start"
find . -type f | awk '!/\047/ { system("md5sum \047" $0 "\047") }'
echo "md5_end"

cd - >/dev/null
rm -rf $tf
